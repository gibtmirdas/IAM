define("tinymce/dom/Selection",["tinymce/dom/TreeWalker","tinymce/dom/TridentSelection","tinymce/dom/ControlSelection","tinymce/dom/RangeUtils","tinymce/Env","tinymce/util/Tools"],function(j,h,a,f,g,e){var i=e.each,k=e.grep,d=e.trim;var c=g.ie,b=g.opera;function l(q,p,o,n){var m=this;m.dom=q;m.win=p;m.serializer=o;m.editor=n;m.controlSelection=new a(m,n);if(!m.win.getSelection){m.tridentSel=new h(m)}}l.prototype={setCursorLocation:function(o,p){var n=this,m=n.dom.createRng();if(!o){n._moveEndPoint(m,n.editor.getBody(),true);n.setRng(m)}else{m.setStart(o,p);m.setEnd(o,p);n.setRng(m);n.collapse(false)}},getContent:function(q){var o=this,n=o.getRng(),m=o.dom.create("body");var t=o.getSel(),s,r,p;q=q||{};s=r="";q.get=true;q.format=q.format||"html";q.selection=true;o.editor.fire("BeforeGetContent",q);if(q.format=="text"){return o.isCollapsed()?"":(n.text||(t.toString?t.toString():""))}if(n.cloneContents){p=n.cloneContents();if(p){m.appendChild(p)}}else{if(n.item!==undefined||n.htmlText!==undefined){m.innerHTML="<br>"+(n.item?n.item(0).outerHTML:n.htmlText);m.removeChild(m.firstChild)}else{m.innerHTML=n.toString()}}if(/^\s/.test(m.innerHTML)){s=" "}if(/\s+$/.test(m.innerHTML)){r=" "}q.getInner=true;q.content=o.isCollapsed()?"":s+o.serializer.serialize(m,q)+r;o.editor.fire("GetContent",q);return q.content},setContent:function(n,p){var u=this,m=u.getRng(),q,r=u.win.document,t,s;p=p||{format:"html"};p.set=true;p.selection=true;n=p.content=n;if(!p.no_events){u.editor.fire("BeforeSetContent",p)}n=p.content;if(m.insertNode){n+='<span id="__caret">_</span>';if(m.startContainer==r&&m.endContainer==r){r.body.innerHTML=n}else{m.deleteContents();if(r.body.childNodes.length===0){r.body.innerHTML=n}else{if(m.createContextualFragment){m.insertNode(m.createContextualFragment(n))}else{t=r.createDocumentFragment();s=r.createElement("div");t.appendChild(s);s.outerHTML=n;m.insertNode(t)}}}q=u.dom.get("__caret");m=r.createRange();m.setStartBefore(q);m.setEndBefore(q);u.setRng(m);u.dom.remove("__caret");try{u.setRng(m)}catch(o){}}else{if(m.item){r.execCommand("Delete",false,null);m=u.getRng()}if(/^\s+/.test(n)){m.pasteHTML('<span id="__mce_tmp">_</span>'+n);u.dom.remove("__mce_tmp")}else{m.pasteHTML(n)}}if(!p.no_events){u.editor.fire("SetContent",p)}},getStart:function(){var o=this,n=o.getRng(),p,m,r,q;if(n.duplicate||n.item){if(n.item){return n.item(0)}r=n.duplicate();r.collapse(1);p=r.parentElement();if(p.ownerDocument!==o.dom.doc){p=o.dom.getRoot()}m=q=n.parentElement();while((q=q.parentNode)){if(q==p){p=m;break}}return p}else{p=n.startContainer;if(p.nodeType==1&&p.hasChildNodes()){p=p.childNodes[Math.min(p.childNodes.length-1,n.startOffset)]}if(p&&p.nodeType==3){return p.parentNode}return p}},getEnd:function(){var n=this,m=n.getRng(),p,o;if(m.duplicate||m.item){if(m.item){return m.item(0)}m=m.duplicate();m.collapse(0);p=m.parentElement();if(p.ownerDocument!==n.dom.doc){p=n.dom.getRoot()}if(p&&p.nodeName=="BODY"){return p.lastChild||p}return p}else{p=m.endContainer;o=m.endOffset;if(p.nodeType==1&&p.hasChildNodes()){p=p.childNodes[o>0?o-1:o]}if(p&&p.nodeType==3){return p.parentNode}return p}},getBookmark:function(x,z){var B=this,t=B.dom,n,q,p,u,o,v,s="&#xFEFF;",A;function m(D,E){var C=0;i(t.select(D),function(G,F){if(G==E){C=F}});return C}function y(C){function D(I){var E,H,G,F=I?"start":"end";E=C[F+"Container"];H=C[F+"Offset"];if(E.nodeType==1&&E.nodeName=="TR"){G=E.childNodes;E=G[Math.min(I?H:H-1,G.length-1)];if(E){H=I?0:E.childNodes.length;C["set"+(I?"Start":"End")](E,H)}}}D(true);D();return C}function r(){var D=B.getRng(true),C=t.getRoot(),E={};function F(I,N){var H=I[N?"startContainer":"endContainer"],M=I[N?"startOffset":"endOffset"],G=[],J,L,K=0;if(H.nodeType==3){if(z){for(J=H.previousSibling;J&&J.nodeType==3;J=J.previousSibling){M+=J.nodeValue.length}}G.push(M)}else{L=H.childNodes;if(M>=L.length&&L.length){K=1;M=Math.max(0,L.length-1)}G.push(B.dom.nodeIndex(L[M],z)+K)}for(;H&&H!=C;H=H.parentNode){G.push(B.dom.nodeIndex(H,z))}return G}E.start=F(D,true);if(!B.isCollapsed()){E.end=F(D)}return E}if(x==2){v=B.getNode();o=v?v.nodeName:null;if(o=="IMG"){return{name:o,index:m(o,v)}}if(B.tridentSel){return B.tridentSel.getBookmark(x)}return r()}if(x){return{rng:B.getRng()}}n=B.getRng();p=t.uniqueId();u=B.isCollapsed();A="overflow:hidden;line-height:0px";if(n.duplicate||n.item){if(!n.item){q=n.duplicate();try{n.collapse();n.pasteHTML('<span data-mce-type="bookmark" id="'+p+'_start" style="'+A+'">'+s+"</span>");if(!u){q.collapse(false);n.moveToElementText(q.parentElement());if(n.compareEndPoints("StartToEnd",q)===0){q.move("character",-1)}q.pasteHTML('<span data-mce-type="bookmark" id="'+p+'_end" style="'+A+'">'+s+"</span>")}}catch(w){return null}}else{v=n.item(0);o=v.nodeName;return{name:o,index:m(o,v)}}}else{v=B.getNode();o=v.nodeName;if(o=="IMG"){return{name:o,index:m(o,v)}}q=y(n.cloneRange());if(!u){q.collapse(false);q.insertNode(t.create("span",{"data-mce-type":"bookmark",id:p+"_end",style:A},s))}n=y(n);n.collapse(true);n.insertNode(t.create("span",{"data-mce-type":"bookmark",id:p+"_start",style:A},s))}B.moveToBookmark({id:p,keep:1});return{id:p}},moveToBookmark:function(s){var w=this,q=w.dom,m,v,o,x,t,u;function n(D){var y=s[D?"start":"end"],A,B,C,z;if(y){C=y[0];for(B=v,A=y.length-1;A>=1;A--){z=B.childNodes;if(y[A]>z.length-1){return}B=z[y[A]]}if(B.nodeType===3){C=Math.min(y[0],B.nodeValue.length)}if(B.nodeType===1){C=Math.min(y[0],B.childNodes.length)}if(D){m.setStart(B,C)}else{m.setEnd(B,C)}}return true}function p(E){var z=q.get(s.id+"_"+E),D,y,B,C,A=s.keep;if(z){D=z.parentNode;if(E=="start"){if(!A){y=q.nodeIndex(z)}else{D=z.firstChild;y=1}o=x=D;t=u=y}else{if(!A){y=q.nodeIndex(z)}else{D=z.firstChild;y=1}x=D;u=y}if(!A){C=z.previousSibling;B=z.nextSibling;i(k(z.childNodes),function(F){if(F.nodeType==3){F.nodeValue=F.nodeValue.replace(/\uFEFF/g,"")}});while((z=q.get(s.id+"_"+E))){q.remove(z,1)}if(C&&B&&C.nodeType==B.nodeType&&C.nodeType==3&&!b){y=C.nodeValue.length;C.appendData(B.nodeValue);q.remove(B);if(E=="start"){o=x=C;t=u=y}else{x=C;u=y}}}}}function r(y){if(q.isBlock(y)&&!y.innerHTML&&!c){y.innerHTML='<br data-mce-bogus="1" />'}return y}if(s){if(s.start){m=q.createRng();v=q.getRoot();if(w.tridentSel){return w.tridentSel.moveToBookmark(s)}if(n(true)&&n()){w.setRng(m)}}else{if(s.id){p("start");p("end");if(o){m=q.createRng();m.setStart(r(o),t);m.setEnd(r(x),u);w.setRng(m)}}else{if(s.name){w.select(q.select(s.name)[s.index])}else{if(s.rng){w.setRng(s.rng)}}}}}},select:function(q,p){var o=this,r=o.dom,n=r.createRng(),m;o.lastFocusBookmark=null;if(q){if(!p&&o.controlSelection.controlSelect(q)){return}m=r.nodeIndex(q);n.setStart(q.parentNode,m);n.setEnd(q.parentNode,m+1);if(p){o._moveEndPoint(n,q,true);o._moveEndPoint(n,q)}o.setRng(n)}return q},isCollapsed:function(){var n=this,m=n.getRng(),o=n.getSel();if(!m||m.item){return false}if(m.compareEndPoints){return m.compareEndPoints("StartToEnd",m)===0}return !o||m.collapsed},collapse:function(m){var o=this,n=o.getRng(),p;if(n.item){p=n.item(0);n=o.win.document.body.createTextRange();n.moveToElementText(p)}n.collapse(!!m);o.setRng(n)},getSel:function(){var m=this.win;return m.getSelection?m.getSelection():m.document.selection},getRng:function(s){var v=this,u,m,r,t=v.win.document,p;function n(y,z,w){try{return z.compareBoundaryPoints(y,w)}catch(x){return -1}}if(!s&&v.lastFocusBookmark){var o=v.lastFocusBookmark;if(o.startContainer){m=t.createRange();m.setStart(o.startContainer,o.startOffset);m.setEnd(o.endContainer,o.endOffset)}else{m=o}return m}if(s&&v.tridentSel){return v.tridentSel.getRangeAt(0)}try{if((u=v.getSel())){if(u.rangeCount>0){m=u.getRangeAt(0)}else{m=u.createRange?u.createRange():t.createRange()}}}catch(q){}if(c&&m&&m.setStart&&t.selection){try{p=t.selection.createRange()}catch(q){}if(p&&p.item){r=p.item(0);m=t.createRange();m.setStartBefore(r);m.setEndAfter(r)}}if(!m){m=t.createRange?t.createRange():t.body.createTextRange()}if(m.setStart&&m.startContainer.nodeType===9&&m.collapsed){r=v.dom.getRoot();m.setStart(r,0);m.setEnd(r,0)}if(v.selectedRange&&v.explicitRange){if(n(m.START_TO_START,m,v.selectedRange)===0&&n(m.END_TO_END,m,v.selectedRange)===0){m=v.explicitRange}else{v.selectedRange=null;v.explicitRange=null}}return m},setRng:function(m,o){var n=this,q;if(m.select){try{m.select()}catch(p){}return}if(!n.tridentSel){q=n.getSel();if(q){n.explicitRange=m;try{q.removeAllRanges();q.addRange(m)}catch(p){}if(o===false&&q.extend){q.collapse(m.endContainer,m.endOffset);q.extend(m.startContainer,m.startOffset)}n.selectedRange=q.rangeCount>0?q.getRangeAt(0):null}}else{if(m.cloneRange){try{n.tridentSel.addRange(m);return}catch(p){}}}},setNode:function(n){var m=this;m.setContent(m.dom.getOuterHTML(n));return n},getNode:function(){var t=this,m=t.getRng(),p;var n=m.startContainer,u=m.endContainer;var q=m.startOffset,r=m.endOffset,s=t.dom.getRoot();function o(w,v){var x=w;while(w&&w.nodeType===3&&w.length===0){w=v?w.nextSibling:w.previousSibling}return w||x}if(!m){return s}if(m.setStart){p=m.commonAncestorContainer;if(!m.collapsed){if(n==u){if(r-q<2){if(n.hasChildNodes()){p=n.childNodes[q]}}}if(n.nodeType===3&&u.nodeType===3){if(n.length===q){n=o(n.nextSibling,true)}else{n=n.parentNode}if(r===0){u=o(u.previousSibling,false)}else{u=u.parentNode}if(n&&n===u){return n}}}if(p&&p.nodeType==3){return p.parentNode}return p}p=m.item?m.item(0):m.parentElement();if(p.ownerDocument!==t.win.document){p=s}return p},getSelectedBlocks:function(p,o){var n=this,t=n.dom,q,m,s=[];m=t.getRoot();p=t.getParent(p||n.getStart(),t.isBlock);o=t.getParent(o||n.getEnd(),t.isBlock);if(p&&p!=m){s.push(p)}if(p&&o&&p!=o){q=p;var r=new j(p,m);while((q=r.next())&&q!=o){if(t.isBlock(q)){s.push(q)}}}if(o&&p!=o&&o!=m){s.push(o)}return s},isForward:function(){var o=this.dom,m=this.getSel(),p,n;if(!m||!m.anchorNode||!m.focusNode){return true}p=o.createRng();p.setStart(m.anchorNode,m.anchorOffset);p.collapse(true);n=o.createRng();n.setStart(m.focusNode,m.focusOffset);n.collapse(true);return p.compareBoundaryPoints(p.START_TO_START,n)<=0},normalize:function(){var n=this,m=n.getRng();if(!c&&new f(n.dom).normalize(m)){n.setRng(m,n.isForward())}return m},selectorChanged:function(m,p){var n=this,o;if(!n.selectorChangedData){n.selectorChangedData={};o={};n.editor.on("NodeChange",function(t){var s=t.element,u=n.dom,q=u.getParents(s,null,u.getRoot()),r={};i(n.selectorChangedData,function(w,v){i(q,function(x){if(u.is(x,v)){if(!o[v]){i(w,function(y){y(true,{node:x,selector:v,parents:q})});o[v]=w}r[v]=w;return false}})});i(o,function(w,v){if(!r[v]){delete o[v];i(w,function(x){x(false,{node:s,selector:v,parents:q})})}})})}if(!n.selectorChangedData[m]){n.selectorChangedData[m]=[]}n.selectorChangedData[m].push(p);return n},getScrollContainer:function(){var m,n=this.dom.getRoot();while(n&&n.nodeName!="BODY"){if(n.scrollHeight>n.clientHeight){m=n;break}n=n.parentNode}return m},scrollIntoView:function(p){var r,u,v=this,o=v.dom,s=o.getRoot(),m,t;function n(B){var w=0,A=0;var z=B;while(z&&z.nodeType){w+=z.offsetLeft||0;A+=z.offsetTop||0;z=z.offsetParent}return{x:w,y:A}}if(s.nodeName!="BODY"){var q=v.getScrollContainer();if(q){r=n(p).y-n(q).y;t=q.clientHeight;m=q.scrollTop;if(r<m||r+25>m+t){q.scrollTop=r<m?r:r-t+25}return}}u=o.getViewPort(v.editor.getWin());r=o.getPos(p).y;m=u.y;t=u.h;if(r<u.y||r+25>m+t){v.editor.getWin().scrollTo(0,r<m?r:r-t+25)}},_moveEndPoint:function(n,p,r){var m=p,q=new j(p,m);var o=this.dom.schema.getNonEmptyElements();do{if(p.nodeType==3&&d(p.nodeValue).length!==0){if(r){n.setStart(p,0)}else{n.setEnd(p,p.nodeValue.length)}return}if(o[p.nodeName]){if(r){n.setStartBefore(p)}else{if(p.nodeName=="BR"){n.setEndBefore(p)}else{n.setEndAfter(p)}}return}if(g.ie&&g.ie<11&&this.dom.isBlock(p)&&this.dom.isEmpty(p)){if(r){n.setStart(p,0)}else{n.setEnd(p,0)}return}}while((p=(r?q.next():q.prev())));if(m.nodeName=="BODY"){if(r){n.setStart(m,0)}else{n.setEnd(m,m.childNodes.length)}}},destroy:function(){this.win=null;this.controlSelection.destroy()}};return l});