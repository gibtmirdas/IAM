tinymce.PluginManager.add("media",function(d,b){var k=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"'}];function a(l){if(l.indexOf(".mp3")!=-1){return"audio/mpeg"}if(l.indexOf(".wav")!=-1){return"audio/wav"}if(l.indexOf(".mp4")!=-1){return"video/mp4"}if(l.indexOf(".webm")!=-1){return"video/webm"}if(l.indexOf(".ogg")!=-1){return"video/ogg"}if(l.indexOf(".swf")!=-1){return"application/x-shockwave-flash"}return""}function i(n){var m=d.settings.media_scripts;if(m){for(var l=0;l<m.length;l++){if(n.indexOf(m[l].filter)!==-1){return m[l]}}}}function h(){var q,o,l,p;var n=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:true,label:"Source"}];function m(v){var s,u,t,r;s=q.find("#width")[0];u=q.find("#height")[0];t=s.value();r=u.value();if(q.find("#constrain")[0].checked()&&o&&l&&t&&r){if(v.control==s){r=Math.round((t/o)*r);u.value(r)}else{t=Math.round((r/l)*t);s.value(t)}}o=t;l=r}if(d.settings.media_alt_source!==false){n.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"})}if(d.settings.media_poster!==false){n.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"})}if(d.settings.media_dimensions!==false){n.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:m},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:m},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}p=c(d.selection.getNode());o=p.width;l=p.height;q=d.windowManager.open({title:"Insert/edit video",data:p,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){p=j(this.next().find("#embed").value());this.fromJSON(p)},items:n},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(g(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},{id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:e(),multiline:true,label:"Source"}]}],onSubmit:function(){d.insertContent(g(this.toJSON()))}})}function e(){var l=d.selection.getNode();if(l.getAttribute("data-mce-object")){return d.selection.getContent()}}function g(n){var m="";if(!n.source1){tinymce.extend(n,j(n.embed));if(!n.source1){return""}}if(!n.source2){n.source2=""}if(!n.poster){n.poster=""}n.source1=d.convertURL(n.source1,"source");n.source2=d.convertURL(n.source2,"source");n.source1mime=a(n.source1);n.source2mime=a(n.source2);n.poster=d.convertURL(n.poster,"poster");n.flashPlayerUrl=d.convertURL(b+"/moxieplayer.swf","movie");if(n.embed){m=f(n.embed,n,true)}else{tinymce.each(k,function(r){var p,q,o;if((p=r.regex.exec(n.source1))){o=r.url;for(q=0;p[q];q++){o=o.replace("$"+q,function(){return p[q]})}n.source1=o;n.type=r.type;n.width=n.width||r.w;n.height=n.height||r.h}});var l=i(n.source1);if(l){n.type="script";n.width=l.width;n.height=l.height}n.width=n.width||300;n.height=n.height||150;tinymce.each(n,function(p,o){n[o]=d.dom.encode(p)});if(n.type=="iframe"){m+='<iframe src="'+n.source1+'" width="'+n.width+'" height="'+n.height+'"></iframe>'}else{if(n.source1mime=="application/x-shockwave-flash"){m+='<object data="'+n.source1+'" width="'+n.width+'" height="'+n.height+'" type="application/x-shockwave-flash">';if(n.poster){m+='<img src="'+n.poster+'" width="'+n.width+'" height="'+n.height+'" />'}m+="</object>"}else{if(n.source1mime.indexOf("audio")!=-1){if(d.settings.audio_template_callback){m=d.settings.audio_template_callback(n)}else{m+=('<audio controls="controls" src="'+n.source1+'">'+(n.source2?'\n<source src="'+n.source2+'"'+(n.source2mime?' type="'+n.source2mime+'"':"")+" />\n":"")+"</audio>")}}else{if(n.type=="script"){m+='<script src="'+n.source1+'"><\/script>'}else{if(d.settings.video_template_callback){m=d.settings.video_template_callback(n)}else{m=('<video width="'+n.width+'" height="'+n.height+'"'+(n.poster?' poster="'+n.poster+'"':"")+' controls="controls">\n<source src="'+n.source1+'"'+(n.source1mime?' type="'+n.source1mime+'"':"")+" />\n"+(n.source2?'<source src="'+n.source2+'"'+(n.source2mime?' type="'+n.source2mime+'"':"")+" />\n":"")+"</video>")}}}}}}return m}function j(l){var m={};new tinymce.html.SaxParser({validate:false,allow_conditional_comments:true,special:"script,noscript",start:function(o,n){if(!m.source1&&o=="param"){m.source1=n.map.movie}if(o=="iframe"||o=="object"||o=="embed"||o=="video"||o=="audio"){if(!m.type){m.type=o}m=tinymce.extend(n.map,m)}if(o=="script"){var p=i(n.map.src);if(!p){return}m={type:"script",source1:n.map.src,width:p.width,height:p.height}}if(o=="source"){if(!m.source1){m.source1=n.map.src}else{if(!m.source2){m.source2=n.map.src}}}if(o=="img"&&!m.poster){m.poster=n.map.src}}}).parse(l);m.source1=m.source1||m.src||m.data;m.source2=m.source2||"";m.poster=m.poster||"";return m}function c(l){if(l.getAttribute("data-mce-object")){return j(d.serializer.serialize(l,{selection:true}))}return{}}function f(n,q,r){var p=new tinymce.html.Writer();var m=0,o;function l(u,x){var t,v,w,s;for(t in x){w=""+x[t];if(u.map[t]){v=u.length;while(v--){s=u[v];if(s.name==t){if(w){u.map[t]=w;s.value=w}else{delete u.map[t];u.splice(v,1)}}}}else{if(w){u.push({name:t,value:w});u.map[t]=w}}}}new tinymce.html.SaxParser({validate:false,allow_conditional_comments:true,special:"script,noscript",comment:function(s){p.comment(s)},cdata:function(s){p.cdata(s)},text:function(t,s){p.text(t,s)},start:function(t,s,u){switch(t){case"video":case"object":case"embed":case"img":case"iframe":l(s,{width:q.width,height:q.height});break}if(r){switch(t){case"video":l(s,{poster:q.poster,src:""});if(q.source2){l(s,{src:""})}break;case"iframe":l(s,{src:q.source1});break;case"source":m++;if(m<=2){l(s,{src:q["source"+m],type:q["source"+m+"mime"]});if(!q["source"+m]){return}}break;case"img":if(!q.poster){return}o=true;break}}p.start(t,s,u)},end:function(v){if(v=="video"&&r){for(var u=1;u<=2;u++){if(q["source"+u]){var t=[];t.map={};if(m<u){l(t,{src:q["source"+u],type:q["source"+u+"mime"]});p.start("source",t,true)}}}}if(q.poster&&v=="object"&&r&&!o){var s=[];s.map={};l(s,{src:q.poster,width:q.width,height:q.height});p.start("img",s,true)}p.end(v)}},new tinymce.html.Schema({})).parse(n);return p.getContent()}d.on("ResolveName",function(m){var l;if(m.target.nodeType==1&&(l=m.target.getAttribute("data-mce-object"))){m.name=l}});d.on("preInit",function(){var l=d.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(n){l[n]=new RegExp("</"+n+"[^>]*>","gi")});d.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var m=d.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(n){m[n]={}});d.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(p,o){var s=p.length,w,r,x,v,u,n,q;var t;while(s--){r=p[s];if(r.name=="script"){t=i(r.attr("src"));if(!t){continue}}x=new tinymce.html.Node("img",1);x.shortEnded=true;if(t){if(t.width){r.attr("width",t.width.toString())}if(t.height){r.attr("height",t.height.toString())}}n=r.attributes;w=n.length;while(w--){v=n[w].name;u=n[w].value;if(v!=="width"&&v!=="height"&&v!=="style"){if(v=="data"||v=="src"){u=d.convertURL(u,v)}x.attr("data-mce-p-"+v,u)}}q=r.firstChild&&r.firstChild.value;if(q){x.attr("data-mce-html",escape(q));x.firstChild=null}x.attr({width:r.attr("width")||"300",height:r.attr("height")||(o=="audio"?"30":"150"),style:r.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":o,"class":"mce-object mce-object-"+o});r.replace(x)}});d.serializer.addAttributeFilter("data-mce-object",function(p,o){var s=p.length,r,w,u,n,q,x,v;while(s--){r=p[s];v=r.attr(o);w=new tinymce.html.Node(v,1);if(v!="audio"&&v!="script"){w.attr({width:r.attr("width"),height:r.attr("height")})}w.attr({style:r.attr("style")});n=r.attributes;u=n.length;while(u--){var t=n[u].name;if(t.indexOf("data-mce-p-")===0){w.attr(t.substr(11),n[u].value)}}if(v=="script"){w.attr("type","text/javascript")}q=r.attr("data-mce-html");if(q){x=new tinymce.html.Node("#text",3);x.raw=true;x.value=unescape(q);w.append(x)}r.replace(w)}})});d.on("ObjectSelected",function(m){var l=m.target.getAttribute("data-mce-object");if(l=="audio"||l=="script"){m.preventDefault()}});d.on("objectResized",function(n){var m=n.target,l;if(m.getAttribute("data-mce-object")){l=m.getAttribute("data-mce-html");if(l){l=unescape(l);m.setAttribute("data-mce-html",escape(f(l,{width:n.width,height:n.height})))}}});d.addButton("media",{tooltip:"Insert/edit video",onclick:h,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe]"]});d.addMenuItem("media",{icon:"media",text:"Insert video",onclick:h,context:"insert",prependToContext:true})});