tinymce.PluginManager.add("layer",function(f){function c(a){do{if(a.className&&-1!=a.className.indexOf("mceItemLayer")){return a}}while(a=a.parentNode)}function h(a){var d=f.dom;tinymce.each(d.select("div,p",a),function(j){/^(absolute|relative|fixed)$/i.test(j.style.position)&&(j.hasVisual?d.addClass(j,"mceItemVisualAid"):d.removeClass(j,"mceItemVisualAid"),d.addClass(j,"mceItemLayer"))})}function g(q){var p,r,j=[],k=c(f.selection.getNode()),m=-1,e=-1;for(r=[],tinymce.walk(f.getBody(),function(a){1==a.nodeType&&/^(absolute|relative|static)$/i.test(a.style.position)&&r.push(a)},"childNodes"),p=0;p<r.length;p++){j[p]=r[p].style.zIndex?parseInt(r[p].style.zIndex,10):0,0>m&&r[p]==k&&(m=p)}if(0>q){for(p=0;p<j.length;p++){if(j[p]<j[m]){e=p;break}}e>-1?(r[m].style.zIndex=j[e],r[e].style.zIndex=j[m]):j[m]>0&&(r[m].style.zIndex=j[m]-1)}else{for(p=0;p<j.length;p++){if(j[p]>j[m]){e=p;break}}e>-1?(r[m].style.zIndex=j[e],r[e].style.zIndex=j[m]):r[m].style.zIndex=j[m]+1}f.execCommand("mceRepaint")}function i(){var a=f.dom,j=a.getPos(a.getParent(f.selection.getNode(),"*")),e=f.getBody();f.dom.add(e,"div",{style:{position:"absolute",left:j.x,top:j.y>20?j.y:20,width:100,height:100},"class":"mceItemVisualAid mceItemLayer"},f.selection.getContent()||f.getLang("layer.content")),tinymce.Env.ie&&a.setHTML(e,e.innerHTML)}function b(){var a=c(f.selection.getNode());a||(a=f.dom.getParent(f.selection.getNode(),"DIV,P,IMG")),a&&("absolute"==a.style.position.toLowerCase()?(f.dom.setStyles(a,{position:"",left:"",top:"",width:"",height:""}),f.dom.removeClass(a,"mceItemVisualAid"),f.dom.removeClass(a,"mceItemLayer")):(a.style.left||(a.style.left="20px"),a.style.top||(a.style.top="20px"),a.style.width||(a.style.width=a.width?a.width+"px":"100px"),a.style.height||(a.style.height=a.height?a.height+"px":"100px"),a.style.position="absolute",f.dom.setAttrib(a,"data-mce-style",""),f.addVisual(f.getBody())),f.execCommand("mceRepaint"),f.nodeChanged())}f.addCommand("mceInsertLayer",i),f.addCommand("mceMoveForward",function(){g(1)}),f.addCommand("mceMoveBackward",function(){g(-1)}),f.addCommand("mceMakeAbsolute",function(){b()}),f.addButton("moveforward",{title:"layer.forward_desc",cmd:"mceMoveForward"}),f.addButton("movebackward",{title:"layer.backward_desc",cmd:"mceMoveBackward"}),f.addButton("absolute",{title:"layer.absolute_desc",cmd:"mceMakeAbsolute"}),f.addButton("insertlayer",{title:"layer.insertlayer_desc",cmd:"mceInsertLayer"}),f.on("init",function(){tinymce.Env.ie&&f.getDoc().execCommand("2D-Position",!1,!0)}),f.on("mouseup",function(e){var a=c(e.target);a&&f.dom.setAttrib(a,"data-mce-style","")}),f.on("mousedown",function(k){var j,l=k.target,e=f.getDoc();tinymce.Env.gecko&&(c(l)?"on"!==e.designMode&&(e.designMode="on",l=e.body,j=l.parentNode,j.removeChild(l),j.appendChild(l)):"on"==e.designMode&&(e.designMode="off"))}),f.on("NodeChange",h)});