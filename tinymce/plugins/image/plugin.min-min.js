tinymce.PluginManager.add("image",function(f){function d(l,k){function j(n,a){m.parentNode&&m.parentNode.removeChild(m),k({width:n,height:a})}var m=document.createElement("img");m.onload=function(){j(m.clientWidth,m.clientHeight)},m.onerror=function(){j()};var h=m.style;h.visibility="hidden",h.position="fixed",h.bottom=h.left=0,h.width=h.height="auto",document.body.appendChild(m),m.src=l}function c(a){return tinymce.each(a,function(e){e.textStyle=function(){return f.formatter.getCssText({inline:"img",classes:[e.value]})}}),a}function g(a){return function(){var e=f.settings.image_list;"string"==typeof e?tinymce.util.XHR.send({url:e,success:function(h){a(tinymce.util.JSON.parse(h))}}):a(e)}}function b(k){function E(p,o,r){var m,h=[];return tinymce.each(f.settings[p]||r,function(l){var a={text:l.text||l.title,value:l.value};h.push(a),(z[o]===l.value||!m&&l.selected)&&(m=a)}),m&&!z[o]&&(z[o]=m.value,m.selected=!0),h}function t(){var a=[{text:"None",value:""}];return tinymce.each(k,function(h){a.push({text:h.text||h.title,value:f.convertURL(h.value||h.url,"src"),menu:h.menu})}),a}function j(){var l,h,a,m;l=G.find("#width")[0],h=G.find("#height")[0],a=l.value(),m=h.value(),G.find("#constrain")[0].checked()&&x&&w&&a&&m&&(x!=a?(m=Math.round(a/x*m),h.value(m)):(a=Math.round(m/w*a),l.value(a))),x=a,w=m}function H(){function a(l){function h(){l.onload=l.onerror=null,f.selection.select(l),f.nodeChanged()}l.onload=function(){z.width||z.height||D.setAttribs(l,{width:l.clientWidth,height:l.clientHeight}),h()},l.onerror=h}A(),j(),z=tinymce.extend(z,G.toJSON()),z.alt||(z.alt=""),""===z.width&&(z.width=null),""===z.height&&(z.height=null),""===z.style&&(z.style=null),z={src:z.src,alt:z.alt,width:z.width,height:z.height,style:z.style,"class":z["class"]},z["class"]||delete z["class"],f.undoManager.transact(function(){return z.src?(F?D.setAttribs(F,z):(z.id="__mcenew",f.focus(),f.selection.setContent(D.createHTML("img",z)),F=D.get("__mcenew"),D.setAttrib(F,"id",null)),void a(F)):void (F&&(D.remove(F),f.focus(),f.nodeChanged()))})}function e(a){return a&&(a=a.replace(/px$/,"")),a}function B(){q&&q.value(f.convertURL(this.value(),"src")),d(this.value(),function(a){a.width&&a.height&&(x=a.width,w=a.height,G.find("#width").value(x),G.find("#height").value(w))})}function A(){function h(m){return m.length>0&&/^[0-9]+$/.test(m)&&(m+="px"),m}if(f.settings.image_advtab){var a=G.toJSON(),l=D.parseStyle(a.style);delete l.margin,l["margin-top"]=l["margin-bottom"]=h(a.vspace),l["margin-left"]=l["margin-right"]=h(a.hspace),l["border-width"]=h(a.border),G.find("#style").value(D.serializeStyle(D.parseStyle(D.serializeStyle(l))))}}var G,x,w,q,i,z={},D=f.dom,F=f.selection.getNode();x=D.getAttrib(F,"width"),w=D.getAttrib(F,"height"),"IMG"!=F.nodeName||F.getAttribute("data-mce-object")||F.getAttribute("data-mce-placeholder")?F=null:z={src:D.getAttrib(F,"src"),alt:D.getAttrib(F,"alt"),"class":D.getAttrib(F,"class"),width:x,height:w},k&&(q={type:"listbox",label:"Image list",values:t(),value:z.src&&f.convertURL(z.src,"src"),onselect:function(h){var a=G.find("#alt");(!a.value()||h.lastControl&&a.value()==h.lastControl.text())&&a.value(h.control.text()),G.find("#src").value(h.control.value())},onPostRender:function(){q=this}}),f.settings.image_class_list&&(i={name:"class",type:"listbox",label:"Class",values:c(E("image_class_list","class"))});var C=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:!0,onchange:B},q];f.settings.image_description!==!1&&C.push({name:"alt",type:"textbox",label:"Image description"}),f.settings.image_dimensions!==!1&&C.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:j,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:j,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),C.push(i),f.settings.image_advtab?(F&&(z.hspace=e(F.style.marginLeft||F.style.marginRight),z.vspace=e(F.style.marginTop||F.style.marginBottom),z.border=e(F.style.borderWidth),z.style=f.dom.serializeStyle(f.dom.parseStyle(f.dom.getAttrib(F,"style")))),G=f.windowManager.open({title:"Insert/edit image",data:z,bodyType:"tabpanel",body:[{title:"General",type:"form",items:C},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:A},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:H})):G=f.windowManager.open({title:"Insert/edit image",data:z,body:C,onSubmit:H})}f.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:g(b),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"}),f.addMenuItem("image",{icon:"image",text:"Insert image",onclick:g(b),context:"insert",prependToContext:!0})});