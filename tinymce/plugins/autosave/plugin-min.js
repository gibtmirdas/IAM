tinymce.PluginManager.add("autosave",function(j){var d=j.settings,k=tinymce.util.LocalStorage,h,n;h=d.autosave_prefix||"tinymce-autosave-{path}{query}-{id}-";h=h.replace(/\{path\}/g,document.location.pathname);h=h.replace(/\{query\}/g,document.location.search);h=h.replace(/\{id\}/g,j.id);function a(r,p){var q={s:1000,m:60000};r=/^(\d+)([ms]?)$/.exec(""+(r||p));return(r[2]?q[r[2]]:1)*parseInt(r,10)}function c(){var p=parseInt(k.getItem(h+"time"),10)||0;if(new Date().getTime()-p>d.autosave_retention){o(false);return false}return true}function o(p){k.removeItem(h+"draft");k.removeItem(h+"time");if(p!==false){j.fire("RemoveDraft")}}function b(){if(!g()&&j.isDirty()){k.setItem(h+"draft",j.getContent({format:"raw",no_events:true}));k.setItem(h+"time",new Date().getTime());j.fire("StoreDraft")}}function m(){if(c()){j.setContent(k.getItem(h+"draft"),{format:"raw"});j.fire("RestoreDraft")}}function f(){if(!n){setInterval(function(){if(!j.removed){b()}},d.autosave_interval);n=true}}d.autosave_interval=a(d.autosave_interval,"30s");d.autosave_retention=a(d.autosave_retention,"20m");function i(){var p=this;p.disabled(!c());j.on("StoreDraft RestoreDraft RemoveDraft",function(){p.disabled(!c())});f()}function e(){j.undoManager.beforeChange();m();o();j.undoManager.add()}j.addButton("restoredraft",{title:"Restore last draft",onclick:e,onPostRender:i});j.addMenuItem("restoredraft",{text:"Restore last draft",onclick:e,onPostRender:i,context:"file"});function l(){var p;tinymce.each(tinymce.editors,function(q){if(q.plugins.autosave){q.plugins.autosave.storeDraft()}if(!p&&q.isDirty()&&q.getParam("autosave_ask_before_unload",true)){p=q.translate("You have unsaved changes are you sure you want to navigate away?")}});return p}function g(q){var p=j.settings.forced_root_block;q=tinymce.trim(typeof(q)=="undefined"?j.getBody().innerHTML:q);return q===""||new RegExp("^<"+p+"[^>]*>((\u00a0|&nbsp;|[ \t]|<br[^>]*>)+?|)</"+p+">|<br>$","i").test(q)}if(j.settings.autosave_restore_when_empty!==false){j.on("init",function(){if(c()&&g()){m()}});j.on("saveContent",function(){o()})}window.onbeforeunload=l;this.hasDraft=c;this.storeDraft=b;this.restoreDraft=m;this.removeDraft=o;this.isEmpty=g});