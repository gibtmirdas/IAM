tinymce.PluginManager.add("fullpage",function(p){function w(){var a=g();p.windowManager.open({title:"Document properties",data:a,defaults:{type:"textbox",size:40},body:[{name:"title",label:"Title"},{name:"keywords",label:"Keywords"},{name:"description",label:"Description"},{name:"robots",label:"Robots"},{name:"author",label:"Author"},{name:"docencoding",label:"Encoding"}],onSubmit:function(c){j(tinymce.extend(a,c.data))}})}function g(){function e(l,a){var o=l.attr(a);return o||""}var m,d,c=k(),i={};return i.fontface=p.getParam("fullpage_default_fontface",""),i.fontsize=p.getParam("fullpage_default_fontsize",""),m=c.firstChild,7==m.type&&(i.xml_pi=!0,d=/encoding="([^"]+)"/.exec(m.value),d&&(i.docencoding=d[1])),m=c.getAll("#doctype")[0],m&&(i.doctype="<!DOCTYPE"+m.value+">"),m=c.getAll("title")[0],m&&m.firstChild&&(i.title=m.firstChild.value),x(c.getAll("meta"),function(r){var o,s=r.attr("name"),a=r.attr("http-equiv");s?i[s.toLowerCase()]=r.attr("content"):"Content-Type"==a&&(o=/charset\s*=\s*(.*)\s*/gi.exec(r.attr("content")),o&&(i.docencoding=o[1]))}),m=c.getAll("html")[0],m&&(i.langcode=e(m,"lang")||e(m,"xml:lang")),i.stylesheets=[],tinymce.each(c.getAll("link"),function(a){"stylesheet"==a.attr("rel")&&i.stylesheets.push(a.attr("href"))}),m=c.getAll("body")[0],m&&(i.langdir=e(m,"dir"),i.style=e(m,"style"),i.visited_color=e(m,"vlink"),i.link_color=e(m,"link"),i.active_color=e(m,"alink")),i}function j(C){function i(c,a,l){c.attr(a,l?l:void 0)}function m(a){d.firstChild?d.insert(a,d.firstChild):d.append(a)}var A,d,e,z,B,y=p.dom;A=k(),d=A.getAll("head")[0],d||(z=A.getAll("html")[0],d=new h("head",1),z.firstChild?z.insert(d,z.firstChild,!0):z.append(d)),z=A.firstChild,C.xml_pi?(B='version="1.0"',C.docencoding&&(B+=' encoding="'+C.docencoding+'"'),7!=z.type&&(z=new h("xml",7),A.insert(z,A.firstChild,!0)),z.value=B):z&&7==z.type&&z.remove(),z=A.getAll("#doctype")[0],C.doctype?(z||(z=new h("#doctype",10),C.xml_pi?A.insert(z,A.firstChild):m(z)),z.value=C.doctype.substring(9,C.doctype.length-1)):z&&z.remove(),z=null,x(A.getAll("meta"),function(a){"Content-Type"==a.attr("http-equiv")&&(z=a)}),C.docencoding?(z||(z=new h("meta",1),z.attr("http-equiv","Content-Type"),z.shortEnded=!0,m(z)),z.attr("content","text/html; charset="+C.docencoding)):z.remove(),z=A.getAll("title")[0],C.title?(z?z.empty():(z=new h("title",1),m(z)),z.append(new h("#text",3)).value=C.title):z&&z.remove(),x("keywords,description,author,copyright,robots".split(","),function(l){var D,a,c=A.getAll("meta"),t=C[l];for(D=0;D<c.length;D++){if(a=c[D],a.attr("name")==l){return void (t?a.attr("content",t):a.remove())}}t&&(z=new h("meta",1),z.attr("name",l),z.attr("content",t),z.shortEnded=!0,m(z))});var s={};tinymce.each(A.getAll("link"),function(a){"stylesheet"==a.attr("rel")&&(s[a.attr("href")]=a)}),tinymce.each(C.stylesheets,function(a){s[a]||(z=new h("link",1),z.attr({rel:"stylesheet",text:"text/css",href:a}),z.shortEnded=!0,m(z)),delete s[a]}),tinymce.each(s,function(a){a.remove()}),z=A.getAll("body")[0],z&&(i(z,"dir",C.langdir),i(z,"style",C.style),i(z,"vlink",C.visited_color),i(z,"link",C.link_color),i(z,"alink",C.active_color),y.setAttribs(p.getBody(),{style:C.style,dir:C.dir,vLink:C.visited_color,link:C.link_color,aLink:C.active_color})),z=A.getAll("html")[0],z&&(i(z,"lang",C.langcode),i(z,"xml:lang",C.langcode)),d.firstChild||d.remove(),e=new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"}).serialize(A),q=e.substring(0,e.indexOf("</body>"))}function k(){return new tinymce.html.DomParser({validate:!1,root_name:"#document"}).parse(q)}function v(D){function d(a){return a.replace(/<\/?[A-Z]+/g,function(l){return l.toLowerCase()})}var i,B,c,e,C=D.content,z="",s=p.dom;if(!D.selection&&!("raw"==D.format&&q||D.source_view&&p.getParam("fullpage_hide_in_source_view"))){C=C.replace(/<(\/?)BODY/gi,"<$1body"),i=C.indexOf("<body"),-1!=i?(i=C.indexOf(">",i),q=d(C.substring(0,i+1)),B=C.indexOf("</body",i),-1==B&&(B=C.length),D.content=C.substring(i+1,B),u=d(C.substring(B))):(q=b(),u="\n</body>\n</html>"),c=k(),x(c.getAll("style"),function(a){a.firstChild&&(z+=a.firstChild.value)}),e=c.getAll("body")[0],e&&s.setAttribs(p.getBody(),{style:e.attr("style")||"",dir:e.attr("dir")||"",vLink:e.attr("vlink")||"",link:e.attr("link")||"",aLink:e.attr("alink")||""}),s.remove("fullpage_styles");var A=p.getDoc().getElementsByTagName("head")[0];z&&(s.add(A,"style",{id:"fullpage_styles"},z),e=s.get("fullpage_styles"),e.styleSheet&&(e.styleSheet.cssText=z));var r={};tinymce.each(A.getElementsByTagName("link"),function(a){"stylesheet"==a.rel&&a.getAttribute("data-mce-fullpage")&&(r[a.href]=a)}),tinymce.each(c.getAll("link"),function(l){var a=l.attr("href");r[a]||"stylesheet"!=l.attr("rel")||s.add(A,"link",{rel:"stylesheet",text:"text/css",href:a,"data-mce-fullpage":"1"}),delete r[a]}),tinymce.each(r,function(a){a.parentNode.removeChild(a)})}}function b(){var c,d="",a="";return p.getParam("fullpage_default_xml_pi")&&(d+='<?xml version="1.0" encoding="'+p.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),d+=p.getParam("fullpage_default_doctype","<!DOCTYPE html>"),d+="\n<html>\n<head>\n",(c=p.getParam("fullpage_default_title"))&&(d+="<title>"+c+"</title>\n"),(c=p.getParam("fullpage_default_encoding"))&&(d+='<meta http-equiv="Content-Type" content="text/html; charset='+c+'" />\n'),(c=p.getParam("fullpage_default_font_family"))&&(a+="font-family: "+c+";"),(c=p.getParam("fullpage_default_font_size"))&&(a+="font-size: "+c+";"),(c=p.getParam("fullpage_default_text_color"))&&(a+="color: "+c+";"),d+="</head>\n<body"+(a?' style="'+a+'"':"")+">\n"}function f(a){a.selection||a.source_view&&p.getParam("fullpage_hide_in_source_view")||(a.content=tinymce.trim(q)+"\n"+tinymce.trim(a.content)+"\n"+tinymce.trim(u))}var q,u,x=tinymce.each,h=tinymce.html.Node;p.addCommand("mceFullPageProperties",w),p.addButton("fullpage",{title:"Document properties",cmd:"mceFullPageProperties"}),p.addMenuItem("fullpage",{text:"Document properties",cmd:"mceFullPageProperties",context:"file"}),p.on("BeforeSetContent",v),p.on("GetContent",f)});