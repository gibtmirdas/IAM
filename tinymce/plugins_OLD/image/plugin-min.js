tinymce.PluginManager.add("image",function(e){function d(h,j){var g=document.createElement("img");function f(l,k){if(g.parentNode){g.parentNode.removeChild(g)}j({width:l,height:k})}g.onload=function(){f(g.clientWidth,g.clientHeight)};g.onerror=function(){f()};var i=g.style;i.visibility="hidden";i.position="fixed";i.bottom=i.left=0;i.width=i.height="auto";document.body.appendChild(g);g.src=h}function b(f){tinymce.each(f,function(g){g.textStyle=function(){return e.formatter.getCssText({inline:"img",classes:[g.value]})}});return f}function c(f){return function(){var g=e.settings.image_list;if(typeof(g)=="string"){tinymce.util.XHR.send({url:g,success:function(h){f(tinymce.util.JSON.parse(h))}})}else{f(g)}}}function a(i){var n,m={},l=e.dom,o=e.selection.getNode();var g,t,p,f;function s(A,x,z){var y,w=[];tinymce.each(e.settings[A]||z,function(C){var B={text:C.text||C.title,value:C.value};w.push(B);if(m[x]===C.value||(!y&&C.selected)){y=B}});if(y&&!m[x]){m[x]=y.value;y.selected=true}return w}function q(){var w=[{text:"None",value:""}];tinymce.each(i,function(x){w.push({text:x.text||x.title,value:e.convertURL(x.value||x.url,"src"),menu:x.menu})});return w}function j(){var x,z,y,w;x=n.find("#width")[0];z=n.find("#height")[0];y=x.value();w=z.value();if(n.find("#constrain")[0].checked()&&g&&t&&y&&w){if(g!=y){w=Math.round((y/g)*w);z.value(w)}else{y=Math.round((w/t)*y);x.value(y)}}g=y;t=w}function k(){function w(y){function x(){y.onload=y.onerror=null;e.selection.select(y);e.nodeChanged()}y.onload=function(){if(!m.width&&!m.height){l.setAttribs(y,{width:y.clientWidth,height:y.clientHeight})}x()};y.onerror=x}u();j();m=tinymce.extend(m,n.toJSON());if(!m.alt){m.alt=""}if(m.width===""){m.width=null}if(m.height===""){m.height=null}if(m.style===""){m.style=null}m={src:m.src,alt:m.alt,width:m.width,height:m.height,style:m.style,"class":m["class"]};if(!m["class"]){delete m["class"]}e.undoManager.transact(function(){if(!m.src){if(o){l.remove(o);e.focus();e.nodeChanged()}return}if(!o){m.id="__mcenew";e.focus();e.selection.setContent(l.createHTML("img",m));o=l.get("__mcenew");l.setAttrib(o,"id",null)}else{l.setAttribs(o,m)}w(o)})}function v(w){if(w){w=w.replace(/px$/,"")}return w}function r(){if(p){p.value(e.convertURL(this.value(),"src"))}d(this.value(),function(w){if(w.width&&w.height){g=w.width;t=w.height;n.find("#width").value(g);n.find("#height").value(t)}})}g=l.getAttrib(o,"width");t=l.getAttrib(o,"height");if(o.nodeName=="IMG"&&!o.getAttribute("data-mce-object")&&!o.getAttribute("data-mce-placeholder")){m={src:l.getAttrib(o,"src"),alt:l.getAttrib(o,"alt"),"class":l.getAttrib(o,"class"),width:g,height:t}}else{o=null}if(i){p={type:"listbox",label:"Image list",values:q(),value:m.src&&e.convertURL(m.src,"src"),onselect:function(w){var x=n.find("#alt");if(!x.value()||(w.lastControl&&x.value()==w.lastControl.text())){x.value(w.control.text())}n.find("#src").value(w.control.value())},onPostRender:function(){p=this}}}if(e.settings.image_class_list){f={name:"class",type:"listbox",label:"Class",values:b(s("image_class_list","class"))}}var h=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true,onchange:r},p];if(e.settings.image_description!==false){h.push({name:"alt",type:"textbox",label:"Image description"})}if(e.settings.image_dimensions!==false){h.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:j,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:j,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]})}h.push(f);function u(){function y(z){if(z.length>0&&/^[0-9]+$/.test(z)){z+="px"}return z}if(!e.settings.image_advtab){return}var x=n.toJSON();var w=l.parseStyle(x.style);delete w.margin;w["margin-top"]=w["margin-bottom"]=y(x.vspace);w["margin-left"]=w["margin-right"]=y(x.hspace);w["border-width"]=y(x.border);n.find("#style").value(l.serializeStyle(l.parseStyle(l.serializeStyle(w))))}if(e.settings.image_advtab){if(o){m.hspace=v(o.style.marginLeft||o.style.marginRight);m.vspace=v(o.style.marginTop||o.style.marginBottom);m.border=v(o.style.borderWidth);m.style=e.dom.serializeStyle(e.dom.parseStyle(e.dom.getAttrib(o,"style")))}n=e.windowManager.open({title:"Insert/edit image",data:m,bodyType:"tabpanel",body:[{title:"General",type:"form",items:h},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox"},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:u},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:k})}else{n=e.windowManager.open({title:"Insert/edit image",data:m,body:h,onSubmit:k})}}e.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:c(a),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"});e.addMenuItem("image",{icon:"image",text:"Insert image",onclick:c(a),context:"insert",prependToContext:true})});