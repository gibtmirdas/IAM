tinymce.PluginManager.add("link",function(a){function b(d){return function(){var e=a.settings.link_list;"string"==typeof e?tinymce.util.XHR.send({url:e,success:function(f){d(tinymce.util.JSON.parse(f))}}):d(e)}}function c(N){function F(d){var f=O.find("#text");(!f.value()||d.lastControl&&f.value()==d.lastControl.text())&&f.value(d.control.text()),O.find("#href").value(d.control.value())}function H(){var d=[{text:"None",value:""}];return tinymce.each(N,function(f){d.push({text:f.text||f.title,value:a.convertURL(f.value||f.url,"href"),menu:f.menu})}),d}function J(d){return tinymce.each(d,function(f){f.textStyle=function(){return a.formatter.getCssText({inline:"a",classes:[f.value]})}}),d}function R(h,k,f){var g,d=[];return tinymce.each(a.settings[h]||f,function(i){var l={text:i.text||i.title,value:i.value};d.push(l),(Q[k]===i.value||!g&&i.selected)&&(g=l)}),g&&!Q[k]&&(Q[k]=g.value,g.selected=!0),d}function C(f){var d=[];return tinymce.each(a.dom.select("a:not([href])"),function(e){var g=e.name||e.id;g&&d.push({text:g,value:"#"+g,selected:-1!=f.indexOf("#"+g)})}),d.length?(d.unshift({text:"None",value:""}),{name:"anchor",type:"listbox",label:"Anchors",values:d,onselect:F}):void 0}function E(){K&&K.value(a.convertURL(this.value(),"href")),!M&&0===Q.text.length&&q&&this.parent().parent().find("#text")[0].value(this.value())}function B(f){var g=I.getContent();if(/</.test(g)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(g)||-1==g.indexOf("href="))){return !1}if(f){var h,d=f.childNodes;if(0===d.length){return !1}for(h=d.length-1;h>=0;h--){if(3!=d[h].nodeType){return !1}}}return !0}var A,P,M,O,q,z,K,L,G,D,j,Q={},I=a.selection,t=a.dom;A=I.getNode(),P=t.getParent(A,"a[href]"),q=B(),Q.text=M=P?P.innerText||P.textContent:I.getContent({format:"text"}),Q.href=P?t.getAttrib(P,"href"):"",Q.target=P?t.getAttrib(P,"target"):a.settings.default_link_target||null,Q.rel=P?t.getAttrib(P,"rel"):null,Q["class"]=P?t.getAttrib(P,"class"):null,Q.title=P?t.getAttrib(P,"title"):"",q&&(z={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){Q.text=this.value()}}),N&&(K={type:"listbox",label:"Link list",values:H(),onselect:F,value:a.convertURL(Q.href,"href"),onPostRender:function(){K=this}}),a.settings.target_list!==!1&&(G={name:"target",type:"listbox",label:"Target",values:R("target_list","target",[{text:"None",value:""},{text:"New window",value:"_blank"}])}),a.settings.rel_list&&(L={name:"rel",type:"listbox",label:"Rel",values:R("rel_list","rel",[{text:"None",value:""}])}),a.settings.link_class_list&&(D={name:"class",type:"listbox",label:"Class",values:J(R("link_class_list","class"))}),a.settings.link_title!==!1&&(j={name:"title",type:"textbox",label:"Title",value:Q.title}),O=a.windowManager.open({title:"Insert link",data:Q,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:!0,label:"Url",onchange:E,onkeyup:E},z,j,C(Q.href),K,L,G,D],onSubmit:function(g){function h(k,m){var i=a.selection.getRng();window.setTimeout(function(){a.windowManager.confirm(k,function(l){a.selection.setRng(i),m(l)})},0)}function d(){var i={href:f,target:Q.target?Q.target:null,rel:Q.rel?Q.rel:null,"class":Q["class"]?Q["class"]:null,title:Q.title?Q.title:null};P?(a.focus(),q&&Q.text!=M&&("innerText" in P?P.innerText=Q.text:P.textContent=Q.text),t.setAttribs(P,i),I.select(P),a.undoManager.add()):q?a.insertContent(t.createHTML("a",i,t.encode(Q.text))):a.execCommand("mceInsertLink",!1,i)}var f;return Q=tinymce.extend(Q,g.data),(f=Q.href)?f.indexOf("@")>0&&-1==f.indexOf("//")&&-1==f.indexOf("mailto:")?void h("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(e){e&&(f="mailto:"+f),d()}):/^\s*www\./i.test(f)?void h("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(e){e&&(f="http://"+f),d()}):void d():void a.execCommand("unlink")}})}a.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:b(c),stateSelector:"a[href]"}),a.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"}),a.addShortcut("Ctrl+K","",b(c)),this.showDialog=c,a.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:b(c),stateSelector:"a[href]",context:"insert",prependToContext:!0})});