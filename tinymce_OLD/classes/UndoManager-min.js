define("tinymce/UndoManager",["tinymce/Env","tinymce/util/Tools"],function(b,c){var a=c.trim,d;d=new RegExp(["<span[^>]+data-mce-bogus[^>]+>[\u200B\uFEFF]+<\\/span>","<div[^>]+data-mce-bogus[^>]+><\\/div>",'\\s?data-mce-selected="[^"]+"'].join("|"),"gi");return function(i){var m=this,j=0,g=[],h,k,l=0;function e(){return a(i.getContent({format:"raw",no_events:1}).replace(d,""))}function f(n){m.typing=false;m.add({},n)}i.on("init",function(){m.add()});i.on("BeforeExecCommand",function(o){var n=o.command;if(n!="Undo"&&n!="Redo"&&n!="mceRepaint"){m.beforeChange()}});i.on("ExecCommand",function(o){var n=o.command;if(n!="Undo"&&n!="Redo"&&n!="mceRepaint"){f(o)}});i.on("ObjectResizeStart",function(){m.beforeChange()});i.on("SaveContent ObjectResized blur",f);i.dom.bind(i.dom.getRoot(),"dragend",f);i.on("KeyUp",function(o){var n=o.keyCode;if((n>=33&&n<=36)||(n>=37&&n<=40)||n==45||n==13||o.ctrlKey){f();i.nodeChanged()}if(n==46||n==8||(b.mac&&(n==91||n==93))){i.nodeChanged()}if(k&&m.typing){if(!i.isDirty()){i.isNotDirty=!g[0]||e()==g[0].content;if(!i.isNotDirty){i.fire("change",{level:g[0],lastLevel:null})}}i.fire("TypingUndo");k=false;i.nodeChanged()}});i.on("KeyDown",function(o){var n=o.keyCode;if((n>=33&&n<=36)||(n>=37&&n<=40)||n==45){if(m.typing){f(o)}return}if((n<16||n>20)&&n!=224&&n!=91&&!m.typing){m.beforeChange();m.typing=true;m.add({},o);k=true}});i.on("MouseDown",function(n){if(m.typing){f(n)}});i.addShortcut("ctrl+z","","Undo");i.addShortcut("ctrl+y,ctrl+shift+z","","Redo");i.on("AddUndo Undo Redo ClearUndos MouseUp",function(n){if(!n.isDefaultPrevented()){i.nodeChanged()}});m={data:g,typing:false,beforeChange:function(){if(!l){h=i.selection.getBookmark(2,true)}},add:function(s,r){var o,p=i.settings,q;s=s||{};s.content=e();if(l||i.removed){return null}if(i.fire("BeforeAddUndo",{level:s,originalEvent:r}).isDefaultPrevented()){return null}q=g[j];if(q&&q.content==s.content){return null}if(g[j]){g[j].beforeBookmark=h}if(p.custom_undo_redo_levels){if(g.length>p.custom_undo_redo_levels){for(o=0;o<g.length-1;o++){g[o]=g[o+1]}g.length--;j=g.length}}s.bookmark=i.selection.getBookmark(2,true);if(j<g.length-1){g.length=j+1}g.push(s);j=g.length-1;var n={level:s,lastLevel:q,originalEvent:r};i.fire("AddUndo",n);if(j>0){i.isNotDirty=false;i.fire("change",n)}return s},undo:function(){var n;if(m.typing){m.add();m.typing=false}if(j>0){n=g[--j];if(j===0){i.isNotDirty=true}i.setContent(n.content,{format:"raw"});i.selection.moveToBookmark(n.beforeBookmark);i.fire("undo",{level:n})}return n},redo:function(){var n;if(j<g.length-1){n=g[++j];i.setContent(n.content,{format:"raw"});i.selection.moveToBookmark(n.bookmark);i.fire("redo",{level:n})}return n},clear:function(){g=[];j=0;m.typing=false;i.fire("ClearUndos")},hasUndo:function(){return j>0||(m.typing&&g[0]&&e()!=g[0].content)},hasRedo:function(){return j<g.length-1&&!this.typing},transact:function(n){m.beforeChange();try{l++;n()}finally{l--}m.add()}};return m}});