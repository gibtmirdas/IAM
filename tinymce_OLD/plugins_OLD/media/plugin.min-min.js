tinymce.PluginManager.add("media",function(k,u){function j(a){return -1!=a.indexOf(".mp3")?"audio/mpeg":-1!=a.indexOf(".wav")?"audio/wav":-1!=a.indexOf(".mp4")?"video/mp4":-1!=a.indexOf(".webm")?"video/webm":-1!=a.indexOf(".ogg")?"video/ogg":-1!=a.indexOf(".swf")?"application/x-shockwave-flash":""}function b(c){var a=k.settings.media_scripts;if(a){for(var d=0;d<a.length;d++){if(-1!==c.indexOf(a[d].filter)){return a[d]}}}}function f(){function e(o){var i,d,r,m;i=c.find("#width")[0],d=c.find("#height")[0],r=i.value(),m=d.value(),c.find("#constrain")[0].checked()&&n&&w&&r&&m&&(o.control==i?(m=Math.round(r/n*m),d.value(m)):(r=Math.round(m/w*r),i.value(r))),n=r,w=m}var c,n,w,a,s=[{name:"source1",type:"filepicker",filetype:"media",size:40,autofocus:!0,label:"Source"}];k.settings.media_alt_source!==!1&&s.push({name:"source2",type:"filepicker",filetype:"media",size:40,label:"Alternative source"}),k.settings.media_poster!==!1&&s.push({name:"poster",type:"filepicker",filetype:"image",size:40,label:"Poster"}),k.settings.media_dimensions!==!1&&s.push({type:"container",label:"Dimensions",layout:"flex",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:3,size:3,onchange:e},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:3,size:3,onchange:e},{name:"constrain",type:"checkbox",checked:!0,text:"Constrain proportions"}]}),a=g(k.selection.getNode()),n=a.width,w=a.height,c=k.windowManager.open({title:"Insert/edit video",data:a,bodyType:"tabpanel",body:[{title:"General",type:"form",onShowTab:function(){a=v(this.next().find("#embed").value()),this.fromJSON(a)},items:s},{title:"Embed",type:"panel",layout:"flex",direction:"column",align:"stretch",padding:10,spacing:10,onShowTab:function(){this.find("#embed").value(p(this.parent().toJSON()))},items:[{type:"label",text:"Paste your embed code below:",forId:"mcemediasource"},{id:"mcemediasource",type:"textbox",flex:1,name:"embed",value:q(),multiline:!0,label:"Source"}]}],onSubmit:function(){k.insertContent(p(this.toJSON()))}})}function q(){var a=k.selection.getNode();return a.getAttribute("data-mce-object")?k.selection.getContent():void 0}function p(e){var d="";if(!e.source1&&(tinymce.extend(e,v(e.embed)),!e.source1)){return""}if(e.source2||(e.source2=""),e.poster||(e.poster=""),e.source1=k.convertURL(e.source1,"source"),e.source2=k.convertURL(e.source2,"source"),e.source1mime=j(e.source1),e.source2mime=j(e.source2),e.poster=k.convertURL(e.poster,"poster"),e.flashPlayerUrl=k.convertURL(u+"/moxieplayer.swf","movie"),e.embed){d=h(e.embed,e,!0)}else{tinymce.each(l,function(n){var c,a,m;if(c=n.regex.exec(e.source1)){for(m=n.url,a=0;c[a];a++){m=m.replace("$"+a,function(){return c[a]})}e.source1=m,e.type=n.type,e.width=e.width||n.w,e.height=e.height||n.h}});var i=b(e.source1);i&&(e.type="script",e.width=i.width,e.height=i.height),e.width=e.width||300,e.height=e.height||150,tinymce.each(e,function(c,a){e[a]=k.dom.encode(c)}),"iframe"==e.type?d+='<iframe src="'+e.source1+'" width="'+e.width+'" height="'+e.height+'"></iframe>':"application/x-shockwave-flash"==e.source1mime?(d+='<object data="'+e.source1+'" width="'+e.width+'" height="'+e.height+'" type="application/x-shockwave-flash">',e.poster&&(d+='<img src="'+e.poster+'" width="'+e.width+'" height="'+e.height+'" />'),d+="</object>"):-1!=e.source1mime.indexOf("audio")?k.settings.audio_template_callback?d=k.settings.audio_template_callback(e):d+='<audio controls="controls" src="'+e.source1+'">'+(e.source2?'\n<source src="'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':"")+" />\n":"")+"</audio>":"script"==e.type?d+='<script src="'+e.source1+'"><\/script>':d=k.settings.video_template_callback?k.settings.video_template_callback(e):'<video width="'+e.width+'" height="'+e.height+'"'+(e.poster?' poster="'+e.poster+'"':"")+' controls="controls">\n<source src="'+e.source1+'"'+(e.source1mime?' type="'+e.source1mime+'"':"")+" />\n"+(e.source2?'<source src="'+e.source2+'"'+(e.source2mime?' type="'+e.source2mime+'"':"")+" />\n":"")+"</video>"}return d}function v(c){var a={};return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",start:function(m,d){if(a.source1||"param"!=m||(a.source1=d.map.movie),("iframe"==m||"object"==m||"embed"==m||"video"==m||"audio"==m)&&(a.type||(a.type=m),a=tinymce.extend(d.map,a)),"script"==m){var n=b(d.map.src);if(!n){return}a={type:"script",source1:d.map.src,width:n.width,height:n.height}}"source"==m&&(a.source1?a.source2||(a.source2=d.map.src):a.source1=d.map.src),"img"!=m||a.poster||(a.poster=d.map.src)}}).parse(c),a.source1=a.source1||a.src||a.data,a.source2=a.source2||"",a.poster=a.poster||"",a}function g(a){return a.getAttribute("data-mce-object")?v(k.serializer.serialize(a,{selection:!0})):{}}function h(w,n,m){function s(C,A){var z,B,D,c;for(z in A){if(D=""+A[z],C.map[z]){for(B=C.length;B--;){c=C[B],c.name==z&&(D?(C.map[z]=D,c.value=D):(delete C.map[z],C.splice(B,1)))}}else{D&&(C.push({name:z,value:D}),C.map[z]=D)}}}var x,d=new tinymce.html.Writer,y=0;return new tinymce.html.SaxParser({validate:!1,allow_conditional_comments:!0,special:"script,noscript",comment:function(a){d.comment(a)},cdata:function(a){d.cdata(a)},text:function(c,a){d.text(c,a)},start:function(c,a,i){switch(c){case"video":case"object":case"embed":case"img":case"iframe":s(a,{width:n.width,height:n.height})}if(m){switch(c){case"video":s(a,{poster:n.poster,src:""}),n.source2&&s(a,{src:""});break;case"iframe":s(a,{src:n.source1});break;case"source":if(y++,2>=y&&(s(a,{src:n["source"+y],type:n["source"+y+"mime"]}),!n["source"+y])){return}break;case"img":if(!n.poster){return}x=!0}}d.start(c,a,i)},end:function(i){if("video"==i&&m){for(var c=1;2>=c;c++){if(n["source"+c]){var o=[];o.map={},c>y&&(s(o,{src:n["source"+c],type:n["source"+c+"mime"]}),d.start("source",o,!0))}}}if(n.poster&&"object"==i&&m&&!x){var a=[];a.map={},s(a,{src:n.poster,width:n.width,height:n.height}),d.start("img",a,!0)}d.end(i)}},new tinymce.html.Schema({})).parse(w),d.getContent()}var l=[{regex:/youtu\.be\/([\w\-.]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$1"},{regex:/youtube\.com(.+)v=([^&]+)/,type:"iframe",w:425,h:350,url:"//www.youtube.com/embed/$2"},{regex:/vimeo\.com\/([0-9]+)/,type:"iframe",w:425,h:350,url:"//player.vimeo.com/video/$1?title=0&byline=0&portrait=0&color=8dc7dc"},{regex:/maps\.google\.([a-z]{2,3})\/maps\/(.+)msid=(.+)/,type:"iframe",w:425,h:350,url:'//maps.google.com/maps/ms?msid=$2&output=embed"'}];k.on("ResolveName",function(c){var a;1==c.target.nodeType&&(a=c.target.getAttribute("data-mce-object"))&&(c.name=a)}),k.on("preInit",function(){var c=k.schema.getSpecialElements();tinymce.each("video audio iframe object".split(" "),function(d){c[d]=new RegExp("</"+d+"[^>]*>","gi")}),k.schema.addValidElements("object[id|style|width|height|classid|codebase|*],embed[id|style|width|height|type|src|*],video[*],audio[*]");var a=k.schema.getBoolAttrs();tinymce.each("webkitallowfullscreen mozallowfullscreen allowfullscreen".split(" "),function(d){a[d]={}}),k.parser.addNodeFilter("iframe,video,audio,object,embed,script",function(D,y){for(var e,B,A,E,r,w,z,C,x=D.length;x--;){if(B=D[x],"script"!=B.name||(C=b(B.attr("src")))){for(A=new tinymce.html.Node("img",1),A.shortEnded=!0,C&&(C.width&&B.attr("width",C.width.toString()),C.height&&B.attr("height",C.height.toString())),w=B.attributes,e=w.length;e--;){E=w[e].name,r=w[e].value,"width"!==E&&"height"!==E&&"style"!==E&&(("data"==E||"src"==E)&&(r=k.convertURL(r,E)),A.attr("data-mce-p-"+E,r))}z=B.firstChild&&B.firstChild.value,z&&(A.attr("data-mce-html",escape(z)),A.firstChild=null),A.attr({width:B.attr("width")||"300",height:B.attr("height")||("audio"==y?"30":"150"),style:B.attr("style"),src:tinymce.Env.transparentSrc,"data-mce-object":y,"class":"mce-object mce-object-"+y}),B.replace(A)}}}),k.serializer.addAttributeFilter("data-mce-object",function(B,F){for(var A,w,x,E,D,G,y,z=B.length;z--;){for(A=B[z],y=A.attr(F),w=new tinymce.html.Node(y,1),"audio"!=y&&"script"!=y&&w.attr({width:A.attr("width"),height:A.attr("height")}),w.attr({style:A.attr("style")}),E=A.attributes,x=E.length;x--;){var C=E[x].name;0===C.indexOf("data-mce-p-")&&w.attr(C.substr(11),E[x].value)}"script"==y&&w.attr("type","text/javascript"),D=A.attr("data-mce-html"),D&&(G=new tinymce.html.Node("#text",3),G.raw=!0,G.value=unescape(D),w.append(G)),A.replace(w)}})}),k.on("ObjectSelected",function(c){var a=c.target.getAttribute("data-mce-object");("audio"==a||"script"==a)&&c.preventDefault()}),k.on("objectResized",function(d){var c,a=d.target;a.getAttribute("data-mce-object")&&(c=a.getAttribute("data-mce-html"),c&&(c=unescape(c),a.setAttribute("data-mce-html",escape(h(c,{width:d.width,height:d.height})))))}),k.addButton("media",{tooltip:"Insert/edit video",onclick:f,stateSelector:["img[data-mce-object=video]","img[data-mce-object=iframe]"]}),k.addMenuItem("media",{icon:"media",text:"Insert video",onclick:f,context:"insert",prependToContext:!0})});