tinymce.PluginManager.add("template",function(j){function g(a){return function(){var c=j.settings.templates;"string"==typeof c?tinymce.util.XHR.send({url:c,success:function(i){a(tinymce.util.JSON.parse(i))}}):a(c)}}function d(p){function e(l){function i(u){if(-1==u.indexOf("<html>")){var s="";tinymce.each(j.contentCSS,function(a){s+='<link type="text/css" rel="stylesheet" href="'+j.documentBaseURI.toAbsolute(a)+'">'}),u="<!DOCTYPE html><html><head>"+s+"</head><body>"+u+"</body></html>"}u=h(u,"template_preview_replace_values");var r=q.find("iframe")[0].getEl().contentWindow.document;r.open(),r.write(u),r.close()}var n=l.control.value();n.url?tinymce.util.XHR.send({url:n.url,success:function(a){c=a,i(c)}}):(c=n.content,i(c)),q.find("#description")[0].text(l.control.value().description)}var q,c,o=[];return p&&0!==p.length?(tinymce.each(p,function(a){o.push({selected:!o.length,text:a.title,value:{url:a.url,content:a.content,description:a.description}})}),q=j.windowManager.open({title:"Insert template",layout:"flex",direction:"column",align:"stretch",padding:15,spacing:10,items:[{type:"form",flex:0,padding:0,items:[{type:"container",label:"Templates",items:{type:"listbox",label:"Templates",name:"template",values:o,onselect:e}}]},{type:"label",name:"description",label:"Description",text:"Â "},{type:"iframe",flex:1,border:1}],onsubmit:function(){k(!1,c)},width:j.getParam("template_popup_width",600),height:j.getParam("template_popup_height",500)}),void q.find("listbox")[0].fire("select")):void j.windowManager.alert("No templates defined")}function m(q,o){function v(l,i){if(l=""+l,l.length<i){for(var c=0;c<i-l.length;c++){l="0"+l}}return l}var e="Sun Mon Tue Wed Thu Fri Sat Sun".split(" "),s="Sunday Monday Tuesday Wednesday Thursday Friday Saturday Sunday".split(" "),u="Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),p="January February March April May June July August September October November December".split(" ");return o=o||new Date,q=q.replace("%D","%m/%d/%Y"),q=q.replace("%r","%I:%M:%S %p"),q=q.replace("%Y",""+o.getFullYear()),q=q.replace("%y",""+o.getYear()),q=q.replace("%m",v(o.getMonth()+1,2)),q=q.replace("%d",v(o.getDate(),2)),q=q.replace("%H",""+v(o.getHours(),2)),q=q.replace("%M",""+v(o.getMinutes(),2)),q=q.replace("%S",""+v(o.getSeconds(),2)),q=q.replace("%I",""+((o.getHours()+11)%12+1)),q=q.replace("%p",""+(o.getHours()<12?"AM":"PM")),q=q.replace("%B",""+j.translate(p[o.getMonth()])),q=q.replace("%b",""+j.translate(u[o.getMonth()])),q=q.replace("%A",""+j.translate(s[o.getDay()])),q=q.replace("%a",""+j.translate(e[o.getDay()])),q=q.replace("%%","%")}function b(e){var c=j.dom,i=j.getParam("template_replace_values");f(c.select("*",e),function(a){f(i,function(o,n){c.hasClass(a,n)&&"function"==typeof i[n]&&i[n](a)})})}function h(e,c){return f(j.getParam(c),function(l,i){"function"!=typeof l&&(e=e.replace(new RegExp("\\{\\$"+i+"\\}","g"),l))}),e}function k(l,i){function u(c,a){return new RegExp("\\b"+a+"\\b","g").test(c.className)}var r,n,q=j.dom,e=j.selection.getContent();i=h(i,"template_replace_values"),r=q.create("div",null,i),n=q.select(".mceTmpl",r),n&&n.length>0&&(r=q.create("div",null),r.appendChild(n[0].cloneNode(!0))),f(q.select("*",r),function(a){u(a,j.getParam("template_cdate_classes","cdate").replace(/\s+/g,"|"))&&(a.innerHTML=m(j.getParam("template_cdate_format",j.getLang("template.cdate_format")))),u(a,j.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(a.innerHTML=m(j.getParam("template_mdate_format",j.getLang("template.mdate_format")))),u(a,j.getParam("template_selected_content_classes","selcontent").replace(/\s+/g,"|"))&&(a.innerHTML=e)}),b(r),j.execCommand("mceInsertContent",!1,r.innerHTML),j.addVisual()}var f=tinymce.each;j.addCommand("mceInsertTemplate",k),j.addButton("template",{title:"Insert template",onclick:g(d)}),j.addMenuItem("template",{text:"Insert template",onclick:g(d),context:"insert"}),j.on("PreProcess",function(e){var c=j.dom;f(c.select("div",e.node),function(a){c.hasClass(a,"mceTmpl")&&(f(c.select("*",a),function(i){c.hasClass(i,j.getParam("template_mdate_classes","mdate").replace(/\s+/g,"|"))&&(i.innerHTML=m(j.getParam("template_mdate_format",j.getLang("template.mdate_format"))))}),b(a))})})});