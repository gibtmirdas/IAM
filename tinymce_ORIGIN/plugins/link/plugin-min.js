tinymce.PluginManager.add("link",function(c){function b(d){return function(){var e=c.settings.link_list;if(typeof(e)=="string"){tinymce.util.XHR.send({url:e,success:function(f){d(tinymce.util.JSON.parse(f))}})}else{d(e)}}}function a(k){var x={},y=c.selection,t=c.dom,v,p,q;var j,n,l,h,r,o,i,s;function u(z){var A=j.find("#text");if(!A.value()||(z.lastControl&&A.value()==z.lastControl.text())){A.value(z.control.text())}j.find("#href").value(z.control.value())}function g(){var z=[{text:"None",value:""}];tinymce.each(k,function(A){z.push({text:A.text||A.title,value:c.convertURL(A.value||A.url,"href"),menu:A.menu})});return z}function d(z){tinymce.each(z,function(A){A.textStyle=function(){return c.formatter.getCssText({inline:"a",classes:[A.value]})}});return z}function m(D,A,C){var B,z=[];tinymce.each(c.settings[D]||C,function(F){var E={text:F.text||F.title,value:F.value};z.push(E);if(x[A]===F.value||(!B&&F.selected)){B=E}});if(B&&!x[A]){x[A]=B.value;B.selected=true}return z}function f(z){var A=[];tinymce.each(c.dom.select("a:not([href])"),function(B){var C=B.name||B.id;if(C){A.push({text:C,value:"#"+C,selected:z.indexOf("#"+C)!=-1})}});if(A.length){A.unshift({text:"None",value:""});return{name:"anchor",type:"listbox",label:"Anchors",values:A,onselect:u}}}function e(){if(h){h.value(c.convertURL(this.value(),"href"))}if(!q&&x.text.length===0&&n){this.parent().parent().find("#text")[0].value(this.value())}}function w(A){var C=y.getContent();if(/</.test(C)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(C)||C.indexOf("href=")==-1)){return false}if(A){var z=A.childNodes,B;if(z.length===0){return false}for(B=z.length-1;B>=0;B--){if(z[B].nodeType!=3){return false}}}return true}v=y.getNode();p=t.getParent(v,"a[href]");n=w();x.text=q=p?(p.innerText||p.textContent):y.getContent({format:"text"});x.href=p?t.getAttrib(p,"href"):"";x.target=p?t.getAttrib(p,"target"):(c.settings.default_link_target||null);x.rel=p?t.getAttrib(p,"rel"):null;x["class"]=p?t.getAttrib(p,"class"):null;x.title=p?t.getAttrib(p,"title"):"";if(n){l={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){x.text=this.value()}}}if(k){h={type:"listbox",label:"Link list",values:g(),onselect:u,value:c.convertURL(x.href,"href"),onPostRender:function(){h=this}}}if(c.settings.target_list!==false){o={name:"target",type:"listbox",label:"Target",values:m("target_list","target",[{text:"None",value:""},{text:"New window",value:"_blank"}])}}if(c.settings.rel_list){r={name:"rel",type:"listbox",label:"Rel",values:m("rel_list","rel",[{text:"None",value:""}])}}if(c.settings.link_class_list){i={name:"class",type:"listbox",label:"Class",values:d(m("link_class_list","class"))}}if(c.settings.link_title!==false){s={name:"title",type:"textbox",label:"Title",value:x.title}}j=c.windowManager.open({title:"Insert link",data:x,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:true,label:"Url",onchange:e,onkeyup:e},l,s,f(x.href),h,r,o,i],onSubmit:function(C){var z;x=tinymce.extend(x,C.data);z=x.href;function B(E,F){var D=c.selection.getRng();window.setTimeout(function(){c.windowManager.confirm(E,function(G){c.selection.setRng(D);F(G)})},0)}function A(){var D={href:z,target:x.target?x.target:null,rel:x.rel?x.rel:null,"class":x["class"]?x["class"]:null,title:x.title?x.title:null};if(p){c.focus();if(n&&x.text!=q){if("innerText" in p){p.innerText=x.text}else{p.textContent=x.text}}t.setAttribs(p,D);y.select(p);c.undoManager.add()}else{if(n){c.insertContent(t.createHTML("a",D,t.encode(x.text)))}else{c.execCommand("mceInsertLink",false,D)}}}if(!z){c.execCommand("unlink");return}if(z.indexOf("@")>0&&z.indexOf("//")==-1&&z.indexOf("mailto:")==-1){B("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(D){if(D){z="mailto:"+z}A()});return}if(/^\s*www\./i.test(z)){B("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(D){if(D){z="http://"+z}A()});return}A()}})}c.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Ctrl+K",onclick:b(a),stateSelector:"a[href]"});c.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"});c.addShortcut("Ctrl+K","",b(a));this.showDialog=a;c.addMenuItem("link",{icon:"link",text:"Insert link",shortcut:"Ctrl+K",onclick:b(a),stateSelector:"a[href]",context:"insert",prependToContext:true})});